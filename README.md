# EDI Loan Application – Multi‑User Data Collection App (Free‑tier friendly)

This repository contains a ready‑to‑deploy web app for data collectors to submit applicants and an admin to manage/approve/ export data. It enforces **mandatory fields**, **unique Applicant IDs**, **admin‑only editing**, and writes an **Excel workbook** with **Sheet1/Sheet2/Sheet3** (Sheet2 & Sheet3 auto‑update from Sheet1).

You can deploy for **free** using:
- **Streamlit Community Cloud** (no credit card) for hosting the app.
- **Supabase** (Free tier, no credit card) for the cloud database & storage.

> If you cannot create Supabase right now, the app also runs in **local demo mode** (it writes to a local `data/` folder) – but for production use and multi‑user concurrency you should use Supabase.

---

## 1) Create free cloud backends (no payment required)

### A. Supabase (database & storage)
1. Go to https://supabase.com and create a free account (no card needed).
2. Create a **new project** → choose a **strong password** for the database.
3. In **SQL Editor**, run the contents of `supabase_schema.sql` from this repo.
4. In **Settings → API** copy:
   - **Project URL**
   - **anon public key**
   - **service_role key** (admin-only secret; do not expose to collectors)
5. In **Authentication → Providers** ensure **Email** is enabled (or keep app’s custom auth).

### B. Streamlit Community Cloud (hosting)
1. Push this folder to a GitHub repo (public/private).
2. Go to https://share.streamlit.io → **New app** → Select your repo and app file `streamlit_app.py`.
3. In **Advanced settings** add **Secrets** like below:

```toml
# .streamlit/secrets.toml (add this in Streamlit "secrets" UI)
SUPABASE_URL = "https://YOUR-PROJECT.supabase.co"
SUPABASE_ANON_KEY = "paste anon key here"
SUPABASE_SERVICE_ROLE_KEY = "paste service role key here"   # Only used on Admin page
APP_ADMIN_EMAILS = "admin1@your.org,admin2@your.org"       # comma-separated
```

Streamlit will keep these secrets encrypted.

---

## 2) Running locally
```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
streamlit run streamlit_app.py
```
If you don’t set Supabase secrets, the app switches to **Local Demo Mode** and stores JSON+Excel under `data/`.

---

## 3) Admin & User links
- **Collector/User portal:** `/?role=user`
- **Admin portal:** `/?role=admin`  
Both portals enforce login. Admins can **edit** any saved record; collectors **cannot** edit after saving.

---

## 4) Excel export (Sheets 1–3)
The Admin portal can **download** an Excel file (`EDI_export.xlsx`) that contains:
- **Sheet1:** All raw submissions in the exact field order defined in code.
- **Sheet2:** Summary by Region/Zone/Woreda with totals (male/female employees, total employees, capital, revenue).
- **Sheet3:** Summary by Sector & Category of Enterprise.

> The provided `.xlsx` template has merged/form cells that aren’t tabular. To guarantee reliable machine updates without cell collisions, this app uses a **normalized tabular Sheet1** with all mandatory columns (matching your specification), and automatically builds Sheet2 and Sheet3 from Sheet1 every time you export.

---

## 5) Credentials & Roles
- Create user accounts in the **Admin portal** (hashing with bcrypt). Mark collectors as `role="collector"` and admins as `role="admin"`.
- Only **admins** can edit or delete existing submissions and can download the cloud master Excel.

---

## 6) Support for large teams & concurrency
- Every submission gets a unique, sortable **ULID** plus a numeric **Auto Number** generated by the database sequence (Supabase/Postgres).
- All mandatory fields are enforced in the form; users cannot move on without completing them.

---

## 7) Replace logo & title
Put your logo image at `assets/logo.png`. The login screen will show:
**“Entrepreneur Development Institution Loan Application Form”**.

---

## 8) Security Notes
- Never expose `SUPABASE_SERVICE_ROLE_KEY` to collectors; it’s used only in the Admin portal on Streamlit Cloud (stored as a secret).
- Passwords are hashed with **bcrypt**.
- Row Level Security (RLS) in Supabase prevents non‑admins from editing other users’ data when using anon key.
